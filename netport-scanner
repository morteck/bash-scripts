#!/usr/bin/env python3
import paramiko
import subprocess
import requests
import datetime
import time
import sys

# ==== CONFIG ====
HOSTS = {
    "wikijs": {
        "ip": "192.168.1.10",
        "ssh_user": "your_user",
        "ssh_pass": "your_pass",
        "service_restart_cmd": "qm start 101"
    },
}

DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/your_webhook_url"
PING_TIMEOUT = 2
CHECK_INTERVAL = 300  # seconds
LOG_FILE = "service_watchdog.log"
# ================

def log(message):
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    entry = f"[{timestamp}] {message}"
    print(entry)
    with open(LOG_FILE, "a") as f:
        f.write(entry + "\n")

def ping(host):
    try:
        result = subprocess.run(["ping", "-c", "1", "-W", str(PING_TIMEOUT), host],
                                stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        return result.returncode == 0
    except Exception as e:
        log(f"Ping error for {host}: {e}")
        return False

def ssh_restart_service(host_info):
    ip = host_info["ip"]
    user = host_info["ssh_user"]
    password = host_info["ssh_pass"]
    cmd = host_info["service_restart_cmd"]
    try:
        client = paramiko.SSHClient()
        client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        log(f"Attempting SSH to {ip} to restart service...")
        client.connect(ip, username=user, password=password, timeout=10)
        stdin, stdout, stderr = client.exec_command(cmd)
        output = stdout.read().decode().strip()
        errors = stderr.read().decode().strip()
        client.close()
        log(f"Command output: {output}")
        if errors:
            log(f"Command errors: {errors}")
        return True
    except Exception as e:
        log(f"SSH failed for {ip}: {e}")
        return False

def send_discord_alert(message):
    if not DISCORD_WEBHOOK_URL:
        return
    try:
        resp = requests.post(DISCORD_WEBHOOK_URL, json={"content": message}, timeout=5)
        if resp.status_code in (200, 204):
            log("Discord alert sent successfully.")
        else:
            log(f"Failed to send Discord alert: {resp.status_code} {resp.text}")
    except Exception as e:
        log(f"Error sending Discord alert: {e}")

def main():
    log("Starting Service Watchdog...")
    try:
        while True:
            for name, info in HOSTS.items():
                if not ping(info["ip"]):
                    alert_msg = f":warning: Host **{name}** ({info['ip']}) is DOWN! Attempting restart..."
                    log(alert_msg)
                    success = ssh_restart_service(info)
                    if success:
                        send_discord_alert(f":white_check_mark: Restart command sent to **{name}**.")
                    else:
                        send_discord_alert(f":x: Failed to restart **{name}** via SSH.")
                else:
                    log(f"{name} ({info['ip']}) is UP.")
            time.sleep(CHECK_INTERVAL)
    except KeyboardInterrupt:
        log("Service Watchdog stopped by user.")
        sys.exit(0)

if __name__ == "__main__":
    main()
